<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="tv-exercise-editor-wrapper.html">

<link rel="import" href="tv-exercise-markdown.html">
<link rel="import" href="tv-exercise-markdown-editor.html">
<link rel="import" href="tv-exercise-equation.html">
<link rel="import" href="tv-exercise-equation-editor.html">
<link rel="import" href="tv-exercise-multiple-choice.html">
<link rel="import" href="tv-exercise-multiple-choice-editor.html">

<dom-module id="tv-exercise-editor">

<template>
<style include="iron-flex"></style>

<style>
:host {
    display: block;
    width: 100%;
    height: 100%;
}

#addWidgetSection {
    position: fixed;
    bottom: 0px;
    right: 0px;
    padding: 20px;
    background-color: #eee;
}

.sidebar {
    margin: 15px;
    min-width: 300px;
}
</style>

<div class="layout horizontal">
    <div class="layout vertical sidebar">
        <paper-input value="{{name}}" label="Opgave navn"></paper-input>
        <paper-toggle-button checked="{{jsonMode}}">JSON Mode</paper-toggle-button>
        <div id="editors">
        </div>
    </div>
    <div class="flex">
        
        <iron-pages selected="{{_computeView(jsonMode)}}">
            <div id="preview">
            </div>
            <div id="json">
                <paper-textarea 
                    id="jsonField"
                    label="JSON" 
                    value="{{_computeJSON(widgets.*)}}">

                </paper-textarea>
                <!-- 
                TODO Create a new field which can set the widgets. We can't 
                just listen on change, since this is complicated. Ideally it 
                should use a button to make sure we don't parse a lot of stuff. 
                Will most likely cause browser crashes otherwise
                -->
                <template is="dom-repeat" items="[[widgets]]">{{item}}</template>
            </div>
        </iron-pages>
    </div>
</div>

<div id="addWidgetSection" class="layout horizontal">
    <div class="layout vertical" style="margin-right: 20px">
        <paper-dropdown-menu label="Tilføj" always-float-label>
            <paper-listbox class="dropdown-content" id="widgetDropdown">
            </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu label="Til" always-float-label>
            <paper-listbox class="dropdown-content" selected="0">
                <paper-item>Dokument</paper-item>
            </paper-listbox>
        </paper-dropdown-menu>
    </div>
    <div class="layout vertical">
        <div class="flex"></div>
        <paper-fab id="addWidget" icon="add" title="Tilføj widget" on-click="_addWidget"></paper-fab>
    </div>
</div>

</template>

<script>
Polymer({
    is: 'tv-exercise-editor',
    properties: {
        name: {
            type: String,
            value: ""
        },
        widgets: {
            type: Array,
            value: [],
            notify: true
        },
        _configuration: {
            type: Object,
            value: {}
        }
    },
    attached: function() {
        this._registerWidgetType(
            "Tekst", 
            "tv-exercise-markdown", 
            "tv-exercise-markdown-editor",
            ["content"]
        );
        
        this._registerWidgetType(
            "Ligning", 
            "tv-exercise-equation", 
            "tv-exercise-equation-editor",
            ["content"]
        );

        this._registerWidgetType(
            "Multiple choice",
            "tv-exercise-multiple-choice",
            "tv-exercise-multiple-choice-editor",
            ["selectmultiple", "choices", "randomizeorder"]
        )

        this.$.widgetDropdown.selected = 0;
    },
    addWidget: function(widget) {
        var self = this;
        this.push("widgets", widget);

        var widgetConfig = this._configuration[widget.type];
        if (widgetConfig) {
            var editor = document.createElement(widgetConfig.editor);
            editor.id = "editor-" + this.widgets.length;

            var wrapper = document.createElement("tv-exercise-editor-wrapper");
            wrapper.appendChild(editor);
            wrapper.name = widget.type + "-" + this.widgets.length;
            this.$.editors.appendChild(wrapper);

            var component = document.createElement(widgetConfig.component);
            component.id = "component-" + this.widgets.length;
            this.$.preview.appendChild(component);

            for (var i = 0; i < widgetConfig.properties.length; i++) {
                self._setupPropertyListener(i, editor, widget, wrapper, 
                    widgetConfig, component);
            }

            for (var property in widget.properties) {
                var value = widget.properties[property];
                editor[property] = value;
            }

            wrapper.addEventListener("delete", function() {
                var index = Array.prototype.slice.call(self.$.editors.children).indexOf(wrapper);
                self.$.editors.removeChild(wrapper);
                self.$.preview.removeChild(component);
                self.splice("widgets", index, 1);
            })
        }
    },
    _setupPropertyListener: function(i, editor, widget, wrapper, widgetConfig, 
                                     component) {
        var self = this;
        var property = widgetConfig.properties[i];
        editor.addEventListener(property + "-changed", function(ev) {
            component[property] = editor[property];
            widget.properties[property] = editor[property];

            console.log("Changing " + property + " with new value " + editor[property]);

            var index = Array.prototype.slice.call(self.$.editors.children).indexOf(wrapper);

            self.push("widgets", {});
            self.splice("widgets", self.widgets.length - 1, 1)
        });
    },
    _registerWidgetType: function(name, component, editor, properties) {
        this._configuration[name] = {
            name: name,
            component: component,
            editor: editor,
            properties: properties
        };
        var item = document.createElement("paper-item");
        item.textContent = name;
        this.$.widgetDropdown.appendChild(item);
    },
    _addWidget: function() {
        this.addWidget({
            "type": this.$.widgetDropdown.selectedItem.textContent,
            "properties": { }
        });
    },
    _computeView: function(jsonMode) {
        return jsonMode ? 1 : 0;
    },
    _computeJSON: function(widgetsSplices) {
        return JSON.stringify(this.widgets);
    }
});
</script>
</dom-module>
